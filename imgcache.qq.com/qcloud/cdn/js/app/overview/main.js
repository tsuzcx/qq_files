define(function(require,t,e){var a=require("cdn/highcharts");var n=require("cdn/dialog");var i=require("cdn/tips");var r=require("cdn/router");var s=require("cdn/lib/underscore");var u=require("cdn/lib/tmpl");var d=require("cdn/lib/util");var c=require("cdn/lib/date");var o=require("cdn/data/dao");var l=require("cdn/data/helper");var _=require("cdn/widgets/widgets");var p=require("../../templates/overview.html.js");require("cdn/components/overviewLinearChart");var f=".cdn-gailan";var h={main:"",section:"",chart:""};function m(t,e){var a=$.Deferred();var e=e||{};e=s.each(e,function(t,a){t===""&&delete e[a]});o[t]({success:{0:function(t){a.resolve(t)},"default":function(t){a.reject(t)}},data:e});return a.promise()}function g(){$("#section_placeholder").html($("#today_section").html());h.section=Bee.mount($("#section_placeholder").get(0),{$data:{real_data:{flux:"-",flux_unit:"",bandwidth:"-",bandwidth_unit:"-bps",requests:"-",requests_unit:"",cache:"-",ip_visits:"-",ip_visits_unit:""},cmp_data:{flux:"-",bandwidth:"-",requests:"-",cache:"-",ip_visits:"-"},pay_type:"",datetime:""},$afterInit:function(){var t=this;if(CDN.base.area==2){$("[_cdn_fee_cal]").hide()}$(f).on("proj_change",function(){t.getGlobalStatData.call(t,{project_id:h.main.projectIdCurrent})})},getGlobalStatData:function(t){var e=this;m("getGlobalStatData",t).then(function(t){var a=t.data;a=e.fixGlobalData(a);s.each(a,function(t,a){e.$set(a,t)})}).fail(function(t){i.error(t.errmsg||t.msg||l._defaultErrMsg)})},fixGlobalData:function(t){t=s.extend({},t);var e=t.real_data;var a=t.cmp_data;var n=_.changeUnit("flux",e.flux);e.flux=n.num;e.flux_unit=n.unit;var i=_.changeUnit("bandwidth",e.bandwidth);e.bandwidth=i.num;e.bandwidth_unit=i.unit;if(e.requests>1e5){if(document.cookie.indexOf("language=en")>-1){e.requests=e.requests/1e3;e.requests_unit="K"}else{e.requests=e.requests/1e4;e.requests_unit="万"}e.requests=d.formatNumber(e.requests,2,",")}else{e.requests_unit="";e.requests=d.formatNumber(e.requests,0,",")}if(e.ip_visits>1e5){if(document.cookie.indexOf("language=en")>-1){e.ip_visits=e.ip_visits/1e3;e.ip_visits_unit="K"}else{e.ip_visits=e.ip_visits/1e4;e.ip_visits_unit="万"}e.ip_visits=d.formatNumber(e.ip_visits,2,",")}else{e.ip_visits_unit="";e.ip_visits=d.formatNumber(e.ip_visits,0,",")}e.cache=d.formatNumber(e.cache,2,"");s.each(a,function(t,e){if(t==null){a[e]="-"}else{a[e]=d.formatNumber(t,2,",")}});return t},resumeNumber:function(t){if(typeof t==="string"){t=t.replace(/,/g,"")}return t},toBandwidth:function(){r.navigate("/cdn/statistics/usage?stat_type=bandwidth")},toFlux:function(){r.navigate("/cdn/statistics/usage")},toRequest:function(){r.navigate("/cdn/statistics/visit")},toVisit:function(){r.navigate("/cdn/statistics/visit?stat_type=ip_visits")},toCache:function(){r.navigate("/cdn/statistics/visit?stat_type=cache")}})}function y(){g()}function v(){h.main=Bee.mount($(".cdn-gailan").get(0),{$data:{isDataReady:false,projectList:[],projSelected:"",projectIdCurrent:"",bulletin:"",permission:false,total_host:"-",user_status:"",pay_type:"",pay_type_str:"",next_pay_type:"",next_pay_type_str:"",flux_data:{flux_data_num:"-",flux_data_unit:"-B"},bandwidth_data:{bandwidth_data_num:"-",bandwidth_data_unit:"-bps"},flux_package:{enable_num:"-",sum_flux_bytes:"-",sum_used_bytes:"-"},month_rate:{flux_data:"-",bandwidth_data:"-"},billing_type:"",billing_type_str:"",total_data:[],running_host:"-",graph:{title:"CDN本月趋势",start_date:"",end_date:"",period:24*60,unit:"",pay_type:"",data_name:"",points:[],showUnit:true,formatterTimeUnit:"MM-DD"},area:CDN.base.area},$afterInit:function(){var t=this;$(f).on("proj_change",function(){t.getGeneralData.call(t,{project_id:t.projectIdCurrent})});this.$watch("user_status",function(t){if(t=="overdue_suspended"){n.create($("#overdue_suspended_dialog").html(),"480","",{title:"停服提醒",closeIcon:true,mask:true,defaultCancelBtn:false,isMaskClickHide:false,buttonHighlight:[1,0],button:{"缴费":function(){window.open("https://"+CDN.domain+"/account/recharge")},"返回":function(){n.hide()}}})}else if(t=="quota_suspended"){n.create($("#quota_suspended_dialog").html(),"480","",{title:"停服提醒",closeIcon:true,mask:true,defaultCancelBtn:false,isMaskClickHide:false,buttonHighlight:[1,0,0],button:{"认证":function(){window.open("https://"+CDN.domain+"/developer/infomation")},"购买流量包":function(){window.open("https://manage.qcloud.com/shoppingcart/shop.php?tab=cdn")},"返回":function(){n.hide()}}})}})},projSelectAction:function(t){h.main.$set("projSelected",t);h.main.$set("projectIdCurrent",t.value);$(f).trigger("proj_change")},getProjectList:function(){m("getProjectList").then(function(t){var e=t.data.projects;var a=[];a.push({label:"全部项目",value:""});s.each(e,function(t){a.push({label:t.name,value:t.id})});h.main.$set("projectList",a);h.main.$set("projSelected",a[0]);$(f).trigger("proj_change")}).fail(function(t){i.error(t.errmsg||t.msg||l._defaultErrMsg)})},getBulletin:function(t){m("getBulletinData",t).then(function(t){h.main.$set("bulletin",t.data.bulletin)}).fail(function(t){i.error(t.errmsg||t.msg||l._defaultErrMsg)})},getGeneralData:function(t){var e=this;m("getGeneralData",t).then(function(t){var a=t.data;a=e.fixGeneralData(a);s.each(a,function(t,a){if(a!=="graph"){e.$set(a,t)}else{e.$replace(a,t)}});e.$set("isDataReady",true)}).fail(function(t){i.error(t.errmsg||t.msg||l._defaultErrMsg)})},fixGeneralData:function(t){t=s.extend({},t);if(t.permission==="MANAGE_HUMAN_RESOURCE"||t.permission==="MANAGE_CLOUD_RESOURCE"){t.permission=true}else if(t.permission==="PRJ_MANAGE_CLOUD_RESOURCE"){t.permission=false}t.pay_type_str=l.pay_type[t.pay_type];t.next_pay_type_str=l.pay_type[t.next_pay_type];t.bandwidth_data={bandwidth_data_num:_.changeUnit(t.pay_type,t.bandwidth_data.china).num,bandwidth_data_unit:_.changeUnit(t.pay_type,t.bandwidth_data.china).unit};t.flux_data={flux_data_num:_.changeUnit(t.pay_type,t.flux_data.china).num,flux_data_unit:_.changeUnit(t.pay_type,t.flux_data.china).unit};t.billing_type_str=l.billing_type[t.billing_type];if(t.month_rate.flux_data==null){t.month_rate.flux_data="-"}else{t.month_rate.flux_data=t.month_rate.flux_data.toFixed(2)}if(t.month_rate.bandwidth_data==null){t.month_rate.bandwidth_data="-"}else{t.month_rate.bandwidth_data=t.month_rate.bandwidth_data.toFixed(2)}t.flux_package.sum_flux_str=_.changeUnit("flux",t.flux_package.sum_flux_bytes).str;t.flux_package.sum_used_str=_.changeUnit("flux",t.flux_package.sum_used_bytes).str;if(t.pay_type==="bandwidth"){t.graph={unit:"b",points:t.total_data.bandwidth_data}}else if(t.pay_type==="flux"){t.graph={unit:"Byte",points:t.total_data.flux_data}}s.extend(t.graph,{title:"CDN本月趋势",start_date:d.format(new Date,"%Y-%m")+"-01",end_date:d.format(new Date,"%Y-%m")+"-"+c.getMonthDays(),period:24*60,data_name:d.format(new Date,"%Y-%m"),pay_type:t.pay_type});return t},modifyPayType:function(t){if(!t){i.error("对不起，您无权变更计费方式");return}var e=$(".chart-area").highcharts().hasData();var a=h.main.billing_type;var r=h.main.pay_type;var s=n.create(u.parse($("#modify_dialog").html(),{billing_type:a,hasData:e,area:CDN.base.area}),"480","",{title:"变更计费方式",preventResubmit:true,"class":"dialog_layer_v2",button:{"确定变更":function(){var t=s.find("[name=paytype]:checked").data("val");if(t==r){n.hide();return}if(h.main.flux_package&&h.main.flux_package.enable_num>0&&t=="bandwidth"&&CDN.base.area==1){n.create($("#confirm_dialog").html(),"480","",{title:"变更计费方式确认",preventResubmit:true,"class":"dialog_layer_v2",button:{"确定变更":function(){h.main.setPaytype({pay_type:t,current:e?0:1})}}});return false}h.main.setPaytype({pay_type:t,current:e?0:1})}}});if(r=="bandwidth"){s.find("[name=paytype][data-val=bandwidth]").prop("checked",true)}else{s.find("[name=paytype][data-val=flux]").prop("checked",true)}},cancelModify:function(t){if(!t){i.error("对不起，您无权变更计费方式");return}h.main.setPaytype({pay_type:h.main.pay_type})},setPaytype:function(t){m("setPaytype",t).then(function(t){i.success("修改计费方式成功");n.hide();$(f).trigger("proj_change")}).fail(function(t){i.error(t.errmsg||t.msg||l._defaultErrMsg)})},payCalculator:function(){window.open("https://"+CDN.buyDomain+"/calculator/cdn")},accessArea:function(){r.navigate("/cdn/access")},fluxArea:function(){r.navigate("/cdn/statistics/usage")},packageArea:function(){r.navigate("/cdn/tools/package")},showAllDetail:function(){r.navigate("/cdn/statistics/monitor/detail?type=cdn&metric=bandwidth")}})}function b(){y();v();h.main.getProjectList();h.main.getBulletin()}return{container:p,render:b}});